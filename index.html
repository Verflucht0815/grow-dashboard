<!DOCTYPE html>
<html>
<head>
    <title>ðŸŒ± GrowController Pro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment"></script>
    <style>
        :root {
            --bg-color: #f5f5f5;
            --text-color: #333;
            --card-bg: white;
            --btn-bg: #4CAF50;
            --btn-text: white;
            --vpd-optimal: #4CAF50;
            --vpd-high: #FF9800;
            --vpd-low: #2196F3;
            --dropdown-bg: white;
            --dropdown-border: #ddd;
        }
        
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #121212;
                --text-color: #f5f5f5;
                --card-bg: #1e1e1e;
                --btn-bg: #2E7D32;
                --dropdown-bg: #2d2d2d;
                --dropdown-border: #444;
            }
        }
        
        body {
            font-family: Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 10px;
            max-width: 100%;
            overflow-x: hidden;
        }
        
        .card {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
        }
        
        h1, h2 {
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        select {
            background-color: var(--dropdown-bg);
            color: var(--text-color);
            border: 1px solid var(--dropdown-border);
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 14px;
        }
        
        .chart-container {
            position: relative;
            width: 100%;
            min-height: 250px;
            margin-bottom: 10px;
        }
        
        .info-container {
            margin-top: 15px;
            padding: 10px;
            background-color: var(--card-bg);
            border-radius: 5px;
            border-left: 4px solid var(--btn-bg);
        }
        
        .info-container h3 {
            margin-top: 0;
            color: var(--btn-bg);
        }
        
        .vpd-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .vpd-table th, .vpd-table td {
            border: 1px solid var(--text-color);
            padding: 6px;
            text-align: center;
        }
        
        .vpd-table th {
            background-color: var(--btn-bg);
            color: var(--btn-text);
        }
        
        .vpd-value {
            font-weight: bold;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            margin: 10px 0;
            background-color: var(--btn-bg);
            color: white;
        }
        
        @media (min-width: 768px) {
            .chart-container {
                min-height: 350px;
            }
            
            .card {
                padding: 20px;
            }
            
            .vpd-table {
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <h1>ðŸŒ± GrowController Pro</h1>
    
    <!-- Temperatur Card -->
    <div class="card">
        <div class="chart-header">
            <h2>Temperatur (Â°C)</h2>
            <select class="time-select">
                <option value="1">1 Stunde</option>
                <option value="6">6 Stunden</option>
                <option value="24" selected>24 Stunden</option>
                <option value="168">7 Tage</option>
                <option value="720">30 Tage</option>
            </select>
        </div>
        <div class="chart-container">
            <canvas id="tempChart"></canvas>
        </div>
        <div class="info-container">
            <h3>Optimale Temperaturwerte</h3>
            <ul>
                <li><strong>Keimling:</strong> 20-25Â°C</li>
                <li><strong>Wachstum:</strong> 22-28Â°C (Tag), 18-22Â°C (Nacht)</li>
                <li><strong>BlÃ¼te:</strong> 20-26Â°C (Tag), 18-21Â°C (Nacht)</li>
            </ul>
        </div>
    </div>
    
    <!-- Luftfeuchtigkeit Card -->
    <div class="card">
        <div class="chart-header">
            <h2>Luftfeuchtigkeit (%)</h2>
            <select class="time-select">
                <option value="1">1 Stunde</option>
                <option value="6">6 Stunden</option>
                <option value="24" selected>24 Stunden</option>
                <option value="168">7 Tage</option>
                <option value="720">30 Tage</option>
            </select>
        </div>
        <div class="chart-container">
            <canvas id="humidityChart"></canvas>
        </div>
        <div class="info-container">
            <h3>Optimale Luftfeuchtigkeit</h3>
            <ul>
                <li><strong>Keimling:</strong> 65-70%</li>
                <li><strong>Wachstum:</strong> 40-70%</li>
                <li><strong>BlÃ¼te:</strong> 40-50% (SchimmelprÃ¤vention)</li>
            </ul>
        </div>
    </div>
    
    <!-- VPD Card -->
    <div class="card">
        <div class="chart-header">
            <h2>VPD (kPa)</h2>
            <select class="time-select">
                <option value="1">1 Stunde</option>
                <option value="6">6 Stunden</option>
                <option value="24" selected>24 Stunden</option>
                <option value="168">7 Tage</option>
                <option value="720">30 Tage</option>
            </select>
        </div>
        <div class="chart-container">
            <canvas id="vpdChart"></canvas>
        </div>
        <div id="currentVpd" class="vpd-value">Aktueller VPD: -- kPa</div>
        <div class="info-container">
            <h3>VPD (Dampfdruckdefizit)</h3>
            <p><strong>Optimalbereiche:</strong></p>
            <ul>
                <li><strong>Keimling:</strong> 0.4-0.8 kPa</li>
                <li><strong>Wachstum:</strong> 0.8-1.2 kPa</li>
                <li><strong>BlÃ¼te:</strong> 1.0-1.5 kPa</li>
            </ul>
            
            <h4>VPD-Referenztabelle</h4>
            <table class="vpd-table">
                <thead>
                    <tr>
                        <th>Temp (Â°C)</th>
                        <th>40% RH</th>
                        <th>50% RH</th>
                        <th>60% RH</th>
                        <th>70% RH</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>20</td>
                        <td>0.93</td>
                        <td>0.70</td>
                        <td>0.47</td>
                        <td>0.23</td>
                    </tr>
                    <tr>
                        <td>22</td>
                        <td>1.05</td>
                        <td>0.81</td>
                        <td>0.57</td>
                        <td>0.33</td>
                    </tr>
                    <tr>
                        <td>24</td>
                        <td>1.19</td>
                        <td>0.93</td>
                        <td>0.68</td>
                        <td>0.42</td>
                    </tr>
                    <tr>
                        <td>26</td>
                        <td>1.34</td>
                        <td>1.07</td>
                        <td>0.80</td>
                        <td>0.53</td>
                    </tr>
                    <tr>
                        <td>28</td>
                        <td>1.51</td>
                        <td>1.23</td>
                        <td>0.94</td>
                        <td>0.65</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // Konfiguration
        const CHANNEL_ID = 2999714;
        const READ_API_KEY = '95YOHGB903ET32DX';
        let tempChart, humidityChart, vpdChart;
        
        // VPD Berechnung (in kPa)
        function calculateVPD(temp, humidity) {
            if (!temp || !humidity) return null;
            
            // SÃ¤ttigungsdampfdruck (Tetens-Formel)
            const svp = 0.61078 * Math.exp((17.27 * temp) / (temp + 237.3));
            
            // TatsÃ¤chlicher Dampfdruck
            const vp = svp * (humidity / 100);
            
            // VPD in kPa
            return (svp - vp).toFixed(2);
        }
        
        // Farben fÃ¼r Dark/Light Mode
        const getChartColors = () => {
            return {
                textColor: getComputedStyle(document.documentElement).getPropertyValue('--text-color'),
                gridColor: window.matchMedia('(prefers-color-scheme: dark)').matches ? 
                          'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)',
                tempColor: '#FF6384',
                humidityColor: '#36A2EB',
                vpdColor: '#9C27B0'
            };
        };
        
        // Diagramme initialisieren
        function initCharts() {
            const colors = getChartColors();
            
            // Temperatur-Chart
            tempChart = new Chart(
                document.getElementById('tempChart').getContext('2d'), 
                getChartConfig('Temperatur', 'Â°C', colors.tempColor, colors)
            );
            
            // Luftfeuchtigkeits-Chart
            humidityChart = new Chart(
                document.getElementById('humidityChart').getContext('2d'), 
                getChartConfig('Luftfeuchtigkeit', '%', colors.humidityColor, colors)
            );
            
            // VPD-Chart
            vpdChart = new Chart(
                document.getElementById('vpdChart').getContext('2d'), 
                getChartConfig('VPD', 'kPa', colors.vpdColor, colors)
            );
        }
        
        // Gemeinsame Chart-Konfiguration
        function getChartConfig(label, unit, color, colors) {
            return {
                type: 'line',
                data: { 
                    datasets: [{ 
                        label: label, 
                        borderColor: color,
                        backgroundColor: color + '20',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.1,
                        data: [] 
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { 
                            type: 'time',
                            time: {
                                tooltipFormat: 'DD.MM HH:mm',
                                unit: 'hour'
                            },
                            grid: { color: colors.gridColor },
                            ticks: { color: colors.textColor }
                        },
                        y: { 
                            title: { 
                                display: true, 
                                text: unit,
                                color: colors.textColor
                            },
                            grid: { color: colors.gridColor },
                            ticks: { color: colors.textColor }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                }
            };
        }
        
        // Daten laden
        async function loadData(chart, hours) {
            try {
                const response = await fetch(
                    `https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?api_key=${READ_API_KEY}&results=${hours*6}`
                );
                const data = await response.json();
                
                // Daten aufbereiten
                const feeds = data.feeds.map(f => ({
                    x: f.created_at,
                    temp: parseFloat(f.field1),
                    humidity: parseFloat(f.field2),
                    vpd: calculateVPD(parseFloat(f.field1), parseFloat(f.field2))
                })).filter(f => !isNaN(f.temp) && !isNaN(f.humidity));
                
                // Charts aktualisieren
                tempChart.data.datasets[0].data = feeds.map(f => ({ x: f.x, y: f.temp }));
                humidityChart.data.datasets[0].data = feeds.map(f => ({ x: f.x, y: f.humidity }));
                vpdChart.data.datasets[0].data = feeds.map(f => ({ x: f.x, y: f.vpd }));
                
                // Zeitachse anpassen
                const timeUnit = hours >= 24 ? 'day' : 'hour';
                tempChart.options.scales.x.time.unit = timeUnit;
                humidityChart.options.scales.x.time.unit = timeUnit;
                vpdChart.options.scales.x.time.unit = timeUnit;
                
                tempChart.update();
                humidityChart.update();
                vpdChart.update();
                
                // Aktuellen VPD-Wert anzeigen
                if (feeds.length > 0) {
                    const lastVpd = feeds[feeds.length-1].vpd;
                    const vpdElement = document.getElementById('currentVpd');
                    vpdElement.textContent = `Aktueller VPD: ${lastVpd} kPa`;
                    
                    // Farbe nach VPD-Bereich
                    if (lastVpd < 0.8) {
                        vpdElement.style.background = 'var(--vpd-low)';
                    } else if (lastVpd > 1.2) {
                        vpdElement.style.background = 'var(--vpd-high)';
                    } else {
                        vpdElement.style.background = 'var(--vpd-optimal)';
                    }
                }
                
            } catch (error) {
                console.error("Fehler:", error);
            }
        }
        
        // Event-Listener fÃ¼r Dropdowns
        document.querySelectorAll('.time-select').forEach(select => {
            select.addEventListener('change', function() {
                const hours = parseInt(this.value);
                const chartId = this.closest('.card').querySelector('canvas').id;
                
                switch(chartId) {
                    case 'tempChart':
                        loadData(tempChart, hours);
                        break;
                    case 'humidityChart':
                        loadData(humidityChart, hours);
                        break;
                    case 'vpdChart':
                        loadData(vpdChart, hours);
                        break;
                }
            });
        });
        
        // Dark Mode Ã„nderungen Ã¼berwachen
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
            const colors = getChartColors();
            
            [tempChart, humidityChart, vpdChart].forEach(chart => {
                chart.options.scales.x.ticks.color = colors.textColor;
                chart.options.scales.y.ticks.color = colors.textColor;
                chart.options.scales.y.title.color = colors.textColor;
                chart.options.scales.x.grid.color = colors.gridColor;
                chart.options.scales.y.grid.color = colors.gridColor;
                chart.update();
            });
        });
        
        // Initialisierung
        initCharts();
        document.querySelectorAll('.time-select').forEach(select => {
            select.dispatchEvent(new Event('change'));
        });
    });
    </script>
</body>
</html>
