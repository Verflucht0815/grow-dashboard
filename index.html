<!DOCTYPE html>
<html>
<head>
    <title>üå± GrowController Pro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment"></script>
    <style>
        :root {
            --bg-color: #f5f5f5;
            --text-color: #333;
            --card-bg: white;
            --btn-bg: #4CAF50;
            --btn-text: white;
            --vpd-optimal: #4CAF50;
            --vpd-high: #FF9800;
            --vpd-low: #2196F3;
        }
        
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #121212;
                --text-color: #f5f5f5;
                --card-bg: #1e1e1e;
                --btn-bg: #2E7D32;
            }
        }
        
        body {
            font-family: Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 10px;
            max-width: 100%;
            overflow-x: hidden;
        }
        
        .card {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
        }
        
        h1, h2 {
            text-align: center;
            margin-bottom: 15px;
        }
        
        .time-btn {
            background-color: var(--btn-bg);
            color: var(--btn-text);
            border: none;
            padding: 8px 12px;
            margin: 3px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .time-btn.active {
            transform: scale(1.05);
            box-shadow: 0 0 5px var(--btn-bg);
        }
        
        .btn-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 5px;
            margin-bottom: 15px;
        }
        
        .chart-container {
            position: relative;
            width: 100%;
            min-height: 250px;
            margin-bottom: 10px;
        }
        
        .info-btn {
            background: none;
            border: none;
            color: var(--text-color);
            opacity: 0.7;
            font-size: 12px;
            cursor: help;
            text-decoration: underline;
            display: block;
            margin: 5px auto;
            text-align: center;
        }
        
        .info-box {
            display: none;
            background-color: var(--card-bg);
            border: 1px solid var(--btn-bg);
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            font-size: 13px;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .vpd-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 14px;
        }
        
        .vpd-table th, .vpd-table td {
            border: 1px solid var(--text-color);
            padding: 8px;
            text-align: center;
        }
        
        .vpd-table th {
            background-color: var(--btn-bg);
            color: var(--btn-text);
        }
        
        .vpd-value {
            font-weight: bold;
            padding: 5px;
            border-radius: 3px;
            text-align: center;
            margin-top: 5px;
        }
        
        @media (min-width: 768px) {
            .chart-container {
                min-height: 350px;
            }
            
            .card {
                padding: 20px;
            }
            
            .info-box {
                max-width: 80%;
                margin-left: auto;
                margin-right: auto;
            }
        }
    </style>
</head>
<body>
    <h1>üå± GrowController Pro</h1>
    
    <div class="btn-container">
        <button class="time-btn">1h</button>
        <button class="time-btn">6h</button>
        <button class="time-btn active">24h</button>
        <button class="time-btn">7d</button>
    </div>
    
    <!-- Temperatur Card -->
    <div class="card">
        <h2>Temperatur (¬∞C)</h2>
        <div class="chart-container">
            <canvas id="tempChart"></canvas>
        </div>
        <button class="info-btn">‚ÑπÔ∏è Optimale Werte anzeigen</button>
        <div class="info-box">
            <p><strong>Optimalbereich f√ºr Cannabis:</strong></p>
            <ul>
                <li>Keimling: 20-25¬∞C</li>
                <li>Wachstum: 22-28¬∞C (Tag), 18-22¬∞C (Nacht)</li>
                <li>Bl√ºte: 20-26¬∞C (Tag), 18-21¬∞C (Nacht)</li>
            </ul>
        </div>
    </div>
    
    <!-- Luftfeuchtigkeit Card -->
    <div class="card">
        <h2>Luftfeuchtigkeit (%)</h2>
        <div class="chart-container">
            <canvas id="humidityChart"></canvas>
        </div>
        <button class="info-btn">‚ÑπÔ∏è Optimale Werte anzeigen</button>
        <div class="info-box">
            <p><strong>Optimalbereich f√ºr Cannabis:</strong></p>
            <ul>
                <li>Keimling: 65-70%</li>
                <li>Wachstum: 40-70%</li>
                <li>Bl√ºte: 40-50% (um Schimmel vorzubeugen)</li>
            </ul>
        </div>
    </div>
    
    <!-- VPD Card -->
    <div class="card">
        <h2>VPD (kPa)</h2>
        <div class="chart-container">
            <canvas id="vpdChart"></canvas>
        </div>
        <div id="currentVpd" class="vpd-value"></div>
        <button class="info-btn">‚ÑπÔ∏è VPD-Informationen</button>
        <div class="info-box">
            <p><strong>Vapor Pressure Deficit (Dampfdruckdefizit):</strong></p>
            <p>Optimaler VPD-Bereich f√ºr Cannabis:</p>
            <ul>
                <li>Keimling: 0.4-0.8 kPa</li>
                <li>Wachstum: 0.8-1.2 kPa</li>
                <li>Bl√ºte: 1.0-1.5 kPa</li>
            </ul>
            
            <table class="vpd-table">
                <thead>
                    <tr>
                        <th>Temp (¬∞C)</th>
                        <th>40% RH</th>
                        <th>50% RH</th>
                        <th>60% RH</th>
                        <th>70% RH</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>20</td>
                        <td>0.93</td>
                        <td>0.70</td>
                        <td>0.47</td>
                        <td>0.23</td>
                    </tr>
                    <tr>
                        <td>22</td>
                        <td>1.05</td>
                        <td>0.81</td>
                        <td>0.57</td>
                        <td>0.33</td>
                    </tr>
                    <tr>
                        <td>24</td>
                        <td>1.19</td>
                        <td>0.93</td>
                        <td>0.68</td>
                        <td>0.42</td>
                    </tr>
                    <tr>
                        <td>26</td>
                        <td>1.34</td>
                        <td>1.07</td>
                        <td>0.80</td>
                        <td>0.53</td>
                    </tr>
                    <tr>
                        <td>28</td>
                        <td>1.51</td>
                        <td>1.23</td>
                        <td>0.94</td>
                        <td>0.65</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // Konfiguration
        const CHANNEL_ID = 2999714;
        const READ_API_KEY = '95YOHGB903ET32DX';
        let tempChart, humidityChart, vpdChart;
        
        // VPD Berechnung (in kPa)
        function calculateVPD(temp, humidity) {
            if (!temp || !humidity) return null;
            
            // S√§ttigungsdampfdruck (Tetens-Formel)
            const svp = 0.61078 * Math.exp((17.27 * temp) / (temp + 237.3));
            
            // Tats√§chlicher Dampfdruck
            const vp = svp * (humidity / 100);
            
            // VPD in kPa
            return (svp - vp).toFixed(2);
        }
        
        // Farben f√ºr Dark/Light Mode
        const getChartColors = () => {
            return {
                textColor: getComputedStyle(document.documentElement).getPropertyValue('--text-color'),
                gridColor: window.matchMedia('(prefers-color-scheme: dark)').matches ? 
                          'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)',
                tempColor: '#FF6384',
                humidityColor: '#36A2EB',
                vpdColor: '#9C27B0'
            };
        };
        
        // Diagramme initialisieren
        function initCharts() {
            const colors = getChartColors();
            
            // Temperatur-Chart
            tempChart = new Chart(
                document.getElementById('tempChart').getContext('2d'), 
                getChartConfig('Temperatur', '¬∞C', colors.tempColor, colors)
            );
            
            // Luftfeuchtigkeits-Chart
            humidityChart = new Chart(
                document.getElementById('humidityChart').getContext('2d'), 
                getChartConfig('Luftfeuchtigkeit', '%', colors.humidityColor, colors)
            );
            
            // VPD-Chart
            vpdChart = new Chart(
                document.getElementById('vpdChart').getContext('2d'), 
                getChartConfig('VPD', 'kPa', colors.vpdColor, colors)
            );
        }
        
        // Gemeinsame Chart-Konfiguration
        function getChartConfig(label, unit, color, colors) {
            return {
                type: 'line',
                data: { 
                    datasets: [{ 
                        label: label, 
                        borderColor: color,
                        backgroundColor: color + '20',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.1,
                        data: [] 
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { 
                            type: 'time',
                            time: {
                                tooltipFormat: 'DD.MM HH:mm',
                                unit: 'hour'
                            },
                            grid: { color: colors.gridColor },
                            ticks: { color: colors.textColor }
                        },
                        y: { 
                            title: { 
                                display: true, 
                                text: unit,
                                color: colors.textColor
                            },
                            grid: { color: colors.gridColor },
                            ticks: { color: colors.textColor }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                }
            };
        }
        
        // Daten laden
        async function loadData(hours) {
            try {
                const response = await fetch(
                    `https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?api_key=${READ_API_KEY}&results=${hours*6}`
                );
                const data = await response.json();
                
                // Daten aufbereiten
                const feeds = data.feeds.map(f => ({
                    x: f.created_at,
                    temp: parseFloat(f.field1),
                    humidity: parseFloat(f.field2),
                    vpd: calculateVPD(parseFloat(f.field1), parseFloat(f.field2))
                })).filter(f => !isNaN(f.temp) && !isNaN(f.humidity));
                
                // Charts aktualisieren
                tempChart.data.datasets[0].data = feeds.map(f => ({ x: f.x, y: f.temp }));
                humidityChart.data.datasets[0].data = feeds.map(f => ({ x: f.x, y: f.humidity }));
                vpdChart.data.datasets[0].data = feeds.map(f => ({ x: f.x, y: f.vpd }));
                
                // Zeitachse anpassen
                const timeUnit = hours >= 24 ? 'day' : 'hour';
                [tempChart, humidityChart, vpdChart].forEach(chart => {
                    chart.options.scales.x.time.unit = timeUnit;
                    chart.update();
                });
                
                // Aktuellen VPD-Wert anzeigen
                if (feeds.length > 0) {
                    const lastVpd = feeds[feeds.length-1].vpd;
                    const vpdElement = document.getElementById('currentVpd');
                    vpdElement.textContent = `Aktueller VPD: ${lastVpd} kPa`;
                    
                    // Farbe nach VPD-Bereich
                    if (lastVpd < 0.8) {
                        vpdElement.style.background = 'var(--vpd-low)';
                    } else if (lastVpd > 1.2) {
                        vpdElement.style.background = 'var(--vpd-high)';
                    } else {
                        vpdElement.style.background = 'var(--vpd-optimal)';
                    }
                }
                
            } catch (error) {
                console.error("Fehler:", error);
            }
        }
        
        // Event-Listener f√ºr Buttons
        document.querySelectorAll('.time-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // Aktiven Button markieren
                document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // Stunden berechnen (1h, 6h, 24h, 7d)
                const text = btn.textContent;
                const hours = text.includes('d') ? 
                    parseInt(text) * 24 : 
                    parseInt(text);
                
                loadData(hours);
            });
        });
        
        // Info-Buttons
        document.querySelectorAll('.info-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const infoBox = btn.nextElementSibling;
                infoBox.style.display = infoBox.style.display === 'block' ? 'none' : 'block';
            });
        });
        
        // Dark Mode √Ñnderungen √ºberwachen
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
            const colors = getChartColors();
            
            [tempChart, humidityChart, vpdChart].forEach(chart => {
                chart.options.scales.x.ticks.color = colors.textColor;
                chart.options.scales.y.ticks.color = colors.textColor;
                chart.options.scales.y.title.color = colors.textColor;
                chart.options.scales.x.grid.color = colors.gridColor;
                chart.options.scales.y.grid.color = colors.gridColor;
                chart.update();
            });
        });
        
        // Initialisierung
        initCharts();
        document.querySelector('.time-btn.active').click();
    });
    </script>
</body>
</html>
