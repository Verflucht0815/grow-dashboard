<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>üå± GrowController Pro</title>

<!-- Chart.js & Moment.js f√ºr Zeitachsen -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment"></script>

<style>
  :root {
    --bg-color: #f0f4f2;
    --text-color: #1a1a1a;
    --card-bg: #fff;
    --nav-bg: #2f6b3e;
    --nav-text: #fff;
    --btn-bg: #2f6b3e;
    --btn-hover-bg: #3e8c4d;
    --btn-text: #fff;
    --border-color: #d4d9d4;
    --shadow: 0 4px 15px rgba(0,0,0,0.1);
    --accent-color: #4caf50;
    --accent-bg: #e6f4e6;
  }
  body {
    margin: 0;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background-color: var(--bg-color);
    color: var(--text-color);
  }
  .main-nav {
    background-color: var(--nav-bg);
    display: flex;
    justify-content: center;
    padding: 15px 10px;
    box-shadow: var(--shadow);
    position: sticky;
    top: 0;
    z-index: 100;
  }
  .main-btn {
    background-color: var(--btn-bg);
    color: var(--btn-text);
    border: none;
    padding: 12px 24px;
    margin: 0 12px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.25s ease;
    user-select: none;
    font-size: 1rem;
    flex-shrink: 0;
  }
  .main-btn:hover, .main-btn.active {
    background-color: var(--btn-hover-bg);
  }
  .sub-nav {
    background-color: #e9f0e8;
    padding: 10px 15px;
    display: flex;
    gap: 12px;
    justify-content: center;
    border-bottom: 1px solid var(--border-color);
    box-shadow: inset 0 -2px 3px rgba(0,0,0,0.05);
  }
  .nav-btn {
    background-color: #a7c49c;
    border: none;
    padding: 8px 20px;
    border-radius: 6px;
    font-weight: 600;
    color: var(--text-color);
    cursor: pointer;
    transition: background-color 0.25s ease;
    flex-shrink: 0;
  }
  .nav-btn:hover, .nav-btn.active {
    background-color: #6a9a59;
    color: white;
  }
  .module {
    max-width: 900px;
    margin: 25px auto;
    padding: 0 20px 30px 20px;
  }
  .card {
    background-color: var(--card-bg);
    border-radius: 12px;
    padding: 25px 30px;
    margin-bottom: 30px;
    box-shadow: var(--shadow);
    line-height: 1.5;
  }
  h2, h3 {
    color: var(--nav-bg);
    margin-top: 0;
  }
  /* Steuerung */
  #control .control-list {
    list-style: none;
    padding-left: 0;
    margin: 0;
  }
  #control .control-list li {
    background: #e9f0e8;
    border-radius: 8px;
    margin-bottom: 15px;
    padding: 14px 18px;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
  }
  #control .control-list li:hover {
    background-color: #c6ddb0;
  }
  .toggle-switch {
    position: relative;
    width: 46px;
    height: 24px;
    display: inline-block;
  }
  .toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }
  .slider {
    position: absolute;
    cursor: pointer;
    top: 0; left: 0; right: 0; bottom: 0;
    background-color: #ccc;
    transition: 0.3s;
    border-radius: 34px;
  }
  .slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: 0.3s;
    border-radius: 50%;
  }
  input:checked + .slider {
    background-color: var(--accent-color);
  }
  input:checked + .slider:before {
    transform: translateX(22px);
  }
  /* Dimmer Slider */
  .dimmer-container {
    display: flex;
    align-items: center;
    gap: 15px;
  }
  .dimmer-slider {
    -webkit-appearance: none;
    width: 180px;
    height: 8px;
    background: #ddd;
    border-radius: 5px;
    outline: none;
    cursor: pointer;
  }
  .dimmer-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 22px;
    height: 22px;
    background: var(--accent-color);
    cursor: pointer;
    border-radius: 50%;
    box-shadow: 0 0 6px rgba(76,175,80,0.7);
    border: none;
    margin-top: -7px;
  }
  .dimmer-slider::-moz-range-thumb {
    width: 22px;
    height: 22px;
    background: var(--accent-color);
    cursor: pointer;
    border-radius: 50%;
    box-shadow: 0 0 6px rgba(76,175,80,0.7);
    border: none;
  }
  /* Verbrauchsanzeige rund */
  .power-display {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background-color: var(--accent-bg);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    font-weight: 700;
    color: var(--accent-color);
    box-shadow: 0 0 10px var(--accent-color);
    user-select: none;
    font-size: 1.3rem;
  }
  /* Graph Container */
  .graph-card {
    margin-top: 20px;
  }
  canvas {
    max-width: 100%;
    height: 280px !important;
  }
</style>

</head>
<body>

<!-- Navigation -->
<div class="main-nav">
  <button class="main-btn active" data-main="climate">Klima</button>
  <button class="main-btn" data-main="control">Steuerung</button>
  <button class="main-btn" data-main="guide">Anleitung</button>
</div>

<!-- Klima -->
<div id="climate" class="module active">
  <div class="sub-nav">
    <button class="nav-btn active" data-module="temp">Temperatur</button>
    <button class="nav-btn" data-module="humidity">Luftfeuchtigkeit</button>
    <button class="nav-btn" data-module="vpd">VPD</button>
    <button class="nav-btn" data-module="soil">Bodenfeuchtigkeit</button>
  </div>

  <!-- Temperatur -->
  <div id="temp" class="sub-module active card">
    <h2>Temperatur</h2>
    <p>Aktuelle Temperatur: <strong id="temp-now">-- ¬∞C</strong></p>
    <div class="graph-card">
      <canvas id="tempChart"></canvas>
    </div>
  </div>

  <!-- Luftfeuchtigkeit -->
  <div id="humidity" class="sub-module card">
    <h2>Luftfeuchtigkeit</h2>
    <p>Aktuelle Luftfeuchtigkeit: <strong id="humidity-now">-- %</strong></p>
    <div class="graph-card">
      <canvas id="humidityChart"></canvas>
    </div>
  </div>

  <!-- VPD -->
  <div id="vpd" class="sub-module card">
    <h2>VPD (Vapor Pressure Deficit)</h2>
    <p>Aktueller VPD-Wert: <strong id="vpd-now">-- kPa</strong></p>
    <div class="graph-card">
      <canvas id="vpdChart"></canvas>
    </div>
  </div>

  <!-- Bodenfeuchtigkeit -->
  <div id="soil" class="sub-module card">
    <h2>Bodenfeuchtigkeit</h2>
    <p>Aktuelle Bodenfeuchtigkeit: <strong id="soil-now">-- %</strong></p>
    <div class="graph-card">
      <canvas id="soilChart"></canvas>
    </div>
  </div>
</div>

<!-- Steuerung -->
<div id="control" class="module">
  <div class="card">
    <h2>Steuerung</h2>
    <ul class="control-list">
      <li>
        Licht
        <div class="dimmer-container">
          <input type="range" min="0" max="100" value="50" class="dimmer-slider" id="lightDimmer" />
          <div class="power-display" id="lightPower">-- W</div>
          <label class="toggle-switch" title="Licht An/Aus">
            <input type="checkbox" id="lightSwitch" checked />
            <span class="slider"></span>
          </label>
        </div>
      </li>
      <li>
        Wasserpumpe
        <label class="toggle-switch" title="Wasserpumpe An/Aus">
          <input type="checkbox" id="pumpSwitch" />
          <span class="slider"></span>
        </label>
      </li>
      <li>
        Luftbefeuchter
        <label class="toggle-switch" title="Luftbefeuchter An/Aus">
          <input type="checkbox" id="humidifierSwitch" />
          <span class="slider"></span>
        </label>
      </li>
    </ul>
  </div>
</div>

<!-- Anleitung -->
<div id="guide" class="module">
  <div class="card">
    <h2>Anleitung</h2>
    <div class="guide-nav">
      <button class="guide-btn active" data-guide="erde">Erde</button>
      <button class="guide-btn" data-guide="wasser">Wasser</button>
      <button class="guide-btn" data-guide="duenger">D√ºnger</button>
      <button class="guide-btn" data-guide="ph">pH-Wert</button>
      <button class="guide-btn" data-guide="ecppm">EC / PPM</button>
      <button class="guide-btn" data-guide="licht">Licht Theorie</button>
      <button class="guide-btn" data-guide="training">Trainingsmethoden</button>
    </div>
    <div id="erde" class="guide-section card active">
      <h3>Erde</h3>
      <p>W√§hle eine lockere, n√§hrstoffreiche Erde mit gutem Wasserabfluss.</p>
    </div>
    <div id="wasser" class="guide-section card">
      <h3>Wasser</h3>
      <p>Regelm√§√üige Bew√§sserung mit abgestandenem Wasser. Staun√§sse vermeiden.</p>
    </div>
    <div id="duenger" class="guide-section card">
      <h3>D√ºnger</h3>
      <p>Organisch oder mineralisch, je nach Phase. Dosierung beachten.</p>
    </div>
    <div id="ph" class="guide-section card">
      <h3>pH-Wert</h3>
      <p>Ideal zwischen 5.8 und 6.5. Regelm√§√üig mit Teststreifen kontrollieren.</p>
    </div>
    <div id="ecppm" class="guide-section card">
      <h3>EC / PPM</h3>
      <p>Elektrische Leitf√§higkeit misst die N√§hrstoffkonzentration.</p>
    </div>
    <div id="licht" class="guide-section card">
      <h3>Licht Theorie</h3>
      <p>PAR, Lumen, DLI verstehen. Optimale Beleuchtung mit LED oder NDL.</p>
    </div>
    <div id="training" class="guide-section card">
      <h3>Trainingsmethoden</h3>
      <p>LST, Topping, Scrogging u.v.m. f√ºr besseren Ertrag und Kontrolle.</p>
    </div>
  </div>
</div>

<script>
  // Navigation Hauptmodule
  document.querySelectorAll('.main-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.main-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      document.querySelectorAll('.module').forEach(m => m.classList.remove('active'));
      document.getElementById(btn.dataset.main).classList.add('active');
      // Reset Submodule nav buttons & submodules for Klima
      if(btn.dataset.main === 'climate') {
        const climateModule = document.getElementById('climate');
        climateModule.querySelectorAll('.nav-btn').forEach((b,i) => {
          b.classList.toggle('active', i===0);
        });
        climateModule.querySelectorAll('.sub-module').forEach((sm,i) => {
          sm.classList.toggle('active', i===0);
        });
      }
    });
  });

  // Navigation Submodule Klima
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const parent = btn.closest('.sub-nav');
      parent.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const targetId = btn.dataset.module;
      btn.closest('#climate').querySelectorAll('.sub-module').forEach(sm => {
        sm.classList.toggle('active', sm.id === targetId);
      });
    });
  });

  // Anleitung Navigation
  document.querySelectorAll('.guide-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      btn.closest('.guide-nav').querySelectorAll('.guide-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const target = btn.dataset.guide;
      btn.closest('.card').querySelectorAll('.guide-section').forEach(sec => {
        sec.classList.toggle('active', sec.id === target);
      });
    });
  });

  // ThingSpeak API URLs - Ersetze mit deinen Channel-IDs & API-Keys
  // Beispiel Kanal-IDs: Hier Dummy-Werte, bitte ersetzen!
  const channelIDs = {
    temp: 123456,
    humidity: 123456,
    vpd: 123456,
    soil: 123456
  };
  const readAPIKey = 'DEIN_API_KEY_HIER';

  // Hilfsfunktion: ThingSpeak JSONP Abfrage mit fetch+Promise
  async function fetchThingSpeakField(channelID, field, results=50) {
    const url = `https://api.thingspeak.com/channels/${channelID}/fields/${field}.json?api_key=${readAPIKey}&results=${results}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error("Fehler bei ThingSpeak API");
    const data = await res.json();
    return data.feeds;
  }

  // Funktion um Werte aus Feeds zu extrahieren
  function parseFeeds(feeds, field) {
    return feeds
      .filter(f => f[field] !== null)
      .map(f => ({
        time: new Date(f.created_at),
        value: parseFloat(f[field])
      }));
  }

  // Globale Chart-Objekte
  let charts = {};

  // Funktion Chart erstellen/aktualisieren
  function createChart(ctx, label, dataPoints, color) {
    if(charts[ctx.canvas.id]) {
      charts[ctx.canvas.id].data.datasets[0].data = dataPoints;
      charts[ctx.canvas.id].update();
      return;
    }
    charts[ctx.canvas.id] = new Chart(ctx, {
      type: 'line',
      data: {
        datasets: [{
          label: label,
          data: dataPoints,
          borderColor: color,
          backgroundColor: color+'55',
          fill: true,
          cubicInterpolationMode: 'monotone',
          tension: 0.3,
          pointRadius: 0,
          borderWidth: 2,
          hoverRadius: 4,
          hoverBorderWidth: 3,
          parsing: {
            xAxisKey: 'time',
            yAxisKey: 'value'
          }
        }]
      },
      options: {
        responsive: true,
        interaction: {
          mode: 'nearest',
          intersect: false
        },
        scales: {
          x: {
            type: 'time',
            time: {
              unit: 'hour',
              displayFormats: { hour: 'HH:mm' }
            },
            ticks: {
              maxRotation: 0,
              autoSkip: true,
              maxTicksLimit: 6
            }
          },
          y: {
            beginAtZero: false,
            ticks: { maxTicksLimit: 6 }
          }
        },
        plugins: {
          legend: { display: true }
        }
      }
    });
  }

  // Werte und Charts aktualisieren
  async function updateAllData() {
    try {
      // Temperatur (Field 1)
      const tempFeeds = await fetchThingSpeakField(channelIDs.temp, 1);
      const tempData = parseFeeds(tempFeeds, 'field1');
      if(tempData.length) {
        document.getElementById('temp-now').textContent = tempData[tempData.length-1].value.toFixed(1) + " ¬∞C";
        createChart(document.getElementById('tempChart').getContext('2d'), "Temperatur (¬∞C)", tempData, '#e74c3c');
      }
      // Luftfeuchtigkeit (Field 2)
      const humFeeds = await fetchThingSpeakField(channelIDs.humidity, 2);
      const humData = parseFeeds(humFeeds, 'field2');
      if(humData.length) {
        document.getElementById('humidity-now').textContent = humData[humData.length-1].value.toFixed(1) + " %";
        createChart(document.getElementById('humidityChart').getContext('2d'), "Luftfeuchtigkeit (%)", humData, '#3498db');
      }
      // VPD (Field 3)
      const vpdFeeds = await fetchThingSpeakField(channelIDs.vpd, 3);
      const vpdData = parseFeeds(vpdFeeds, 'field3');
      if(vpdData.length) {
        document.getElementById('vpd-now').textContent = vpdData[vpdData.length-1].value.toFixed(2) + " kPa";
        createChart(document.getElementById('vpdChart').getContext('2d'), "VPD (kPa)", vpdData, '#27ae60');
      }
      // Bodenfeuchtigkeit (Field 4)
      const soilFeeds = await fetchThingSpeakField(channelIDs.soil, 4);
      const soilData = parseFeeds(soilFeeds, 'field4');
      if(soilData.length) {
        document.getElementById('soil-now').textContent = soilData[soilData.length-1].value.toFixed(1) + " %";
        createChart(document.getElementById('soilChart').getContext('2d'), "Bodenfeuchtigkeit (%)", soilData, '#9b59b6');
      }
    } catch (e) {
      console.error("Datenaktualisierung fehlgeschlagen:", e);
    }
  }

  // Initial Update & Wiederholung alle 3 Min.
  updateAllData();
  setInterval(updateAllData, 180000);

  // Steuerungs-UI (Dimmer & Schalter)
  const lightDimmer = document.getElementById('lightDimmer');
  const lightPower = document.getElementById('lightPower');
  const lightSwitch = document.getElementById('lightSwitch');
  const pumpSwitch = document.getElementById('pumpSwitch');
  const humidifierSwitch = document.getElementById('humidifierSwitch');

  // Beispiel Berechnung Verbrauch (50 W bei 100% Licht)
  function updateLightPower() {
    if(lightSwitch.checked) {
      const power = Math.round(lightDimmer.value * 0.5); // 0-50 W
      lightPower.textContent = power + ' W';
    } else {
      lightPower.textContent = '0 W';
    }
  }
  lightDimmer.addEventListener('input', updateLightPower);
  lightSwitch.addEventListener('change', () => {
    updateLightPower();
    lightDimmer.disabled = !lightSwitch.checked;
  });

  // Initial update
  updateLightPower();

  // TODO: Steuerungs-Events an ESP senden (WebSocket/AJAX)

</script>

</body>
</html>

